function setCookie(e,t,o){if(o){var n=new Date;n.setTime(n.getTime()+24*o*60*60*1e3);var a="; expires="+n.toGMTString()}else a="";t=e+"="+t+a+"; path=/";document.cookie=t,console.log("Set cookie : "+t)}function getCookie(e){for(var t=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(var a=o[n];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(t)){var r=a.substring(t.length,a.length);return console.log("Get cookie : "+t+" value: "+r),r}}return null}function getRoomTypeString(e){var t="";return"salon"==e&&(t="Salon"),"lounge"==e&&(t="Salon"),"chambre"==e&&(t="Chambre"),"bedroom"==e&&(t="Chambre"),"cuisine"==e&&(t="Cuisine"),"kitchen"==e&&(t="Cuisine"),"bureau"==e&&(t="Bureau"),"office"==e&&(t="Bureau"),"sam"==e&&(t="Salle a manger"),"diningroom"==e&&(t="Salle a manger"),"cave"==e&&(t="Cave"),"cellar"==e&&(t="Cave"),"divers"==e&&(t="Divers"),"various"==e&&(t="Divers"),"misc"==e&&(t="Divers"),"exterieur"==e&&(t="Exterieur"),"outside"==e&&(t="Exterieur"),"sdb"==e&&(t="Salle de bain"),"bathroom"==e&&(t="Salle de bain"),"hall"==e&&(t="Couloir"),"couloir"==e&&(t="Couloir"),"corridor"==e&&(t="Couloir"),"garage"==e&&(t="Garage"),"Internal"==e&&(t="Internal Room"),t}function getRoomTypeIcon(e){return"salon"==e&&(rname="room_salon.png"),"lounge"==e&&(rname="room_salon.png"),"chambre"==e&&(rname="room_chambre.png"),"bedroom"==e&&(rname="room_chambre.png"),"cuisine"==e&&(rname="room_cuisine.png"),"kitchen"==e&&(rname="room_cuisine.png"),"bureau"==e&&(rname="room_bureau.png"),"office"==e&&(rname="room_bureau.png"),"sam"==e&&(rname="room_sam.png"),"diningroom"==e&&(rname="room_sam.png"),"cave"==e&&(rname="room_cave.png"),"cellar"==e&&(rname="room_cave.png"),"divers"==e&&(rname="room.png"),"various"==e&&(rname="room.png"),"misc"==e&&(rname="room.png"),"exterieur"==e&&(rname="room_exterieur.png"),"outside"==e&&(rname="room_exterieur.png"),"sdb"==e&&(rname="room_sdb.png"),"bathroom"==e&&(rname="room_sdb.png"),"hall"==e&&(rname="room_corridor.png"),"couloir"==e&&(rname="room_corridor.png"),"corridor"==e&&(rname="room_corridor.png"),"garage"==e&&(rname="room_garage.png"),"Internal"==e?rname="room.png":rname,rname}!function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){function e(t,o,n){var a={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};for(var r in n||(n={}),a)void 0!==n[r]?this[r]=n[r]:this[r]=a[r];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var i,s=this,c=!1,l=!1,u=document.createElement("div");function m(e,t){var o=document.createEvent("CustomEvent");return o.initCustomEvent(e,!1,!1,t),o}u.addEventListener("open",function(e){s.onopen(e)}),u.addEventListener("close",function(e){s.onclose(e)}),u.addEventListener("connecting",function(e){s.onconnecting(e)}),u.addEventListener("message",function(e){s.onmessage(e)}),u.addEventListener("error",function(e){s.onerror(e)}),this.addEventListener=u.addEventListener.bind(u),this.removeEventListener=u.removeEventListener.bind(u),this.dispatchEvent=u.dispatchEvent.bind(u),this.open=function(t){i=new WebSocket(s.url,o||[]),t||u.dispatchEvent(m("connecting")),(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",s.url);var n=i,a=setTimeout(function(){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),l=!0,n.close(),l=!1},s.timeoutInterval);i.onopen=function(o){clearTimeout(a),(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",s.url),s.protocol=i.protocol,s.readyState=WebSocket.OPEN,s.reconnectAttempts=0;var n=m("open");n.isReconnect=t,t=!1,u.dispatchEvent(n)},i.onclose=function(o){if(clearTimeout(a),i=null,c)s.readyState=WebSocket.CLOSED,u.dispatchEvent(m("close"));else{s.readyState=WebSocket.CONNECTING;var n=m("connecting");n.code=o.code,n.reason=o.reason,n.wasClean=o.wasClean,u.dispatchEvent(n),t||l||((s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",s.url),u.dispatchEvent(m("close")));var a=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++,s.open(!0)},a>s.maxReconnectInterval?s.maxReconnectInterval:a)}},i.onmessage=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",s.url,t.data);var o=m("message");o.data=t.data,u.dispatchEvent(o)},i.onerror=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",s.url,t),u.dispatchEvent(m("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(i)return(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",s.url,t),i.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){void 0===e&&(e=1e3),c=!0,i&&i.close(e,t)},this.refresh=function(){i&&i.close()}}return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return this.slice(0,e.length)==e}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return this.slice(-e.length)==e}),angular.module("calaosApp",["ngSanitize","ui.router","ngDialog","farbtastic"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/home"),e.state("login",{url:"/login",templateUrl:"views/login.html",data:{requireLogin:!1}}).state("home",{abstract:!0,url:"/home",template:'<div ui-view class="fade"></div>',data:{requireLogin:!0}}).state("home.list",{url:"",templateUrl:"views/home.html"}).state("home.room",{url:"/{roomId:int}",templateUrl:"views/room.html",controller:"RoomCtrl"}).state("audio",{abstract:!0,url:"/audio",template:'<div ui-view class="fade"></div>',data:{requireLogin:!0}}).state("audio.list",{url:"",templateUrl:"views/audiolist.html"}).state("audio.player",{url:"/{playerId}",templateUrl:"views/audio_player.html"}).state("security",{abstract:!0,url:"/security",template:'<div ui-view class="fade"></div>',data:{requireLogin:!0}}).state("security.list",{url:"",templateUrl:"views/cameralist.html"}).state("security.camera",{url:"/{cameraId:int}",templateUrl:"views/camera.html"})}]).run(["$rootScope","$location","$timeout","CalaosApp","$transitions",function(e,t,o,n,a){a.onStart({to:e=>!!e.data.requireLogin},function(e){if(console.log("checking login state"),!n.isAuth())return console.log("not logged in, redirect"),e.router.stateService.target("login")})}]).config(["$sceDelegateProvider",function(e){e.resourceUrlWhitelist(["self","http://127.0.0.1:5454/**"])}]),angular.module("calaosApp").directive("calaosCamera",["$timeout",function(e){return{restrict:"AE",replace:!0,template:"<div></div>",link:function(t,o,n){var a=document.createElement("canvas");a.width=o.width(),a.height=o.height(),o.append(a);var r=a.getContext("2d"),i=new Image;i.src=n.src;i.onload=function(t){a.width=a.width,i.width*i.height>0&&r.drawImage(i,0,0,a.width,a.height),e(function(){i.src=n.src+"&"+(new Date).getTime()},10)}}}}]),angular.module("calaosApp").factory("CalaosApp",["$rootScope","$state","$timeout",function(e,t,o){var n=!1,a=!1,r=!1,i=!1,s="",c="",l={},u=[],m=[],g=[],p={isConnected:function(){return n},isAuth:function(){return r},hasAuthFailed:function(){return i},isLoading:function(){return a},getHomeData:function(){return l},getSortedHomeByRow:function(){return u},getSortedCameraByRow:function(){return m},send:function(e){angular.isString(e)?d.send(e):angular.isObject(e)&&d.send(JSON.stringify(e))},setState:function(e,t){p.send({msg:"set_state",data:{id:e.id,value:t}})},signIn:function(e,t){a=!0,i=!1,r=!1,s=e,c=t,console.log("Trying to sign in with "+s),n&&p.send({msg:"login",data:{cn_user:s,cn_pass:c}})},signOut:function(){a=!1,i=!1,r=!1,s="",c="",l="",u="",e.needGoToHome=!1}},d=new ReconnectingWebSocket(function(){if(""!==calaosDevConfig.calaosServerHost)return calaosDevConfig.calaosServerHost;var e="http:"===window.location.protocol?"ws://":"wss://";return e+=window.location.hostname+":"+window.location.port+"/api",console.log("Connecting to "+e),e}());return d.onopen=function(){console.log("websocket open"),e.$apply(function(){n=!0}),i||p.send({msg:"login",data:{cn_user:s,cn_pass:c}})},d.onclose=function(){console.log("websocket closed"),e.$apply(function(){n=!1,a=!1})},d.onerror=function(){console.log("websocket error"),e.$apply(function(){n=!1,o(function(){p.signOut(),t.go("login")},200)})},d.onmessage=function(n){var d=n.data;e.$apply(function(){!function(n){if("login"!=n.msg||r){if("get_home"==n.msg){(l=n.data).home.sort(function(e,t){return t.hits-e.hits}),u=[];for(var d=[],h=0;h<l.home.length;h++){if(l.home[h].icon=getRoomTypeIcon(l.home[h].type),l.home[h].roomId=h,l.home[h].items)for(var f=0;f<l.home[h].items.length;f++)g[l.home[h].items[f].id]=l.home[h].items[f],"temp"!=l.home[h].items[f].gui_type||l.home[h].hasTemp||(l.home[h].hasTemp=!0,l.home[h].temp=l.home[h].items[f]);d.push(h),d.length>=3&&(u.push(d),d=[])}for(d.length>0&&u.push(d),m=[],d=[],h=0;h<l.cameras.length;h++){l.cameras[h].cameraId=h;var v="";if(""!==calaosDevConfig.calaosServerHost){var w=calaosDevConfig.calaosServerHost;w.startsWith("ws://")&&(w=w.slice(5,w.length)),v="http://"+w.slice(0,w.indexOf("/"))+"/api"}else{var C=window.location.protocol+"//";v=C+=window.location.hostname+":"+window.location.port+"/api"}v+="?cn_user="+encodeURIComponent(s),v+="&cn_pass="+encodeURIComponent(c),v+="&action=camera",v+="&type=get_picture",v+="&id="+encodeURIComponent(l.cameras[h].id),l.cameras[h].cam_src=v,d.push(h),d.length>=3&&(m.push(d),d=[])}d.length>0&&m.push(d),a=!1,o(function(){e.isLoading?e.needGoToHome=!0:t.go("home.list")},1500)}else if("event"==n.msg){var b=n.data;console.debug("Received event: ",b),"io_changed"==b.type_str&&g.hasOwnProperty(b.data.id)?(b.data.hasOwnProperty("state")&&(g[b.data.id].state=b.data.state),b.data.hasOwnProperty("name")&&(g[b.data.id].name=b.data.name)):console.debug("Event not implemented!")}}else"true"!==n.data.success?(i=!0,r=!1):(r=!0,p.send({msg:"get_home"}))}(JSON.parse(d))})},p}]),angular.module("calaosApp").factory("preloader",["$q","$rootScope",function(e,t){function o(t){this.imageLocations=t,this.imageCount=this.imageLocations.length,this.loadCount=0,this.errorCount=0,this.states={PENDING:1,LOADING:2,RESOLVED:3,REJECTED:4},this.state=this.states.PENDING,this.deferred=e.defer(),this.promise=this.deferred.promise}return o.preloadImages=function(e){return new o(e).load()},o.prototype={constructor:o,isInitiated:function(){return this.state!==this.states.PENDING},isRejected:function(){return this.state===this.states.REJECTED},isResolved:function(){return this.state===this.states.RESOLVED},load:function(){if(this.isInitiated())return this.promise;this.state=this.states.LOADING;for(var e=0;e<this.imageCount;e++)this.loadImageLocation(this.imageLocations[e]);return this.promise},handleImageError:function(e){this.errorCount++,this.isRejected()||(this.state=this.states.REJECTED,this.deferred.reject(e))},handleImageLoad:function(e){this.loadCount++,this.isRejected()||(this.deferred.notify({percent:Math.ceil(this.loadCount/this.imageCount*100),imageLocation:e}),this.loadCount===this.imageCount&&(this.state=this.states.RESOLVED,this.deferred.resolve(this.imageLocations)))},loadImageLocation:function(e){var o=this;angular.element(new Image).bind("load",function(e){t.$apply(function(){o.handleImageLoad(e.target.src),o=e=null})}).bind("error",function(e){t.$apply(function(){o.handleImageError(e.target.src),o=e=null})}).attr("src",e)}},o}]),angular.module("calaosApp").controller("MainCtrl",["$rootScope","$scope","$state","CalaosApp","$window","preloader",function(e,t,o,n,a,r){e.isLoading=!0,t.loadPercent=0,t.imageLocations=["images/style_icons/icon_default.png","images/style_icons/icon_humidity.png","images/background.png","images/button_bool_off.png","images/button_bool_on.png","images/button_home.png","https://www.lifeofpix.com/wp-content/uploads/2018/03/stmoritz13.jpg?cache="+(new Date).getTime(),"https://www.lifeofpix.com/wp-content/uploads/2018/03/stmoritz13.jpg?v0&cache="+(new Date).getTime(),"https://www.lifeofpix.com/wp-content/uploads/2018/03/stmoritz13.jpg?v1&cache="+(new Date).getTime(),"https://www.lifeofpix.com/wp-content/uploads/2018/03/stmoritz13.jpg?v2&cache="+(new Date).getTime(),"https://www.lifeofpix.com/wp-content/uploads/2018/03/stmoritz13.jpg?v3&cache="+(new Date).getTime(),"https://www.lifeofpix.com/wp-content/uploads/2018/03/stmoritz13.jpg?v4&cache="+(new Date).getTime()],r.preloadImages(t.imageLocations).then(function(){e.isLoading=!1,e.needGoToHome&&o.go("home.list"),console.log("preloading success")},function(){e.isLoading=!1,e.needGoToHome&&o.go("home.list"),console.log("Loading of pic failed.")},function(e){t.percentLoaded=e.percent,console.log("loading progress: "+e.percent+"  "+e.imageLocation)}),t.CalaosApp=n,t.signOut=function(){n.signOut(),o.go("login")},t.goBack=function(){a.history.back()},t.canGoBack=function(){return!!(o.is("home.room")||o.is("audio.player")||o.is("security.camera"))}}]),angular.module("calaosApp").controller("LoginCtrl",["$scope","$state","CalaosApp",function(e,t,o){e.sign_in=function(){o.signIn(e.cn_user,e.cn_pass)}}]),angular.module("calaosApp").controller("HomeCtrl",["$scope","$state","CalaosApp",function(e,t,o){e.homeByRow=o.getSortedHomeByRow(),e.homeRaw=o.getHomeData().home}]),angular.module("calaosApp").controller("RoomCtrl",["$scope","$state","$stateParams","CalaosApp",function(e,t,o,n){var a=n.getHomeData().home;e.room={name:"",icon:"",items:[]},o.roomId<0||o.roomId>=a.length?(console.log("unkown room "+o.roomId),t.go("home")):e.room=a[o.roomId]}]),angular.module("calaosApp").controller("LightDimmerCtrl",["$scope","CalaosApp",function(e,t){var o=function(t){e.percent_value=0,e.bool_status=!1,isNaN(parseInt(t.state))?"set "==t.state.substr(0,4)?e.percent_value=parseInt(t.state.substr(4,t.state.length-4)):"true"==t.state?e.percent_value=100:"false"==t.state&&(e.percent_value=0):e.percent_value=parseInt(t.state),e.bool_status=e.percent_value>0,e.percent_value_rw=e.percent_value};e.changeValueDimmer=function(o){var n="set "+e.percent_value_rw;t.setState(o,n)},o(e.item),e.$watch("item",function(){o(e.item)},!0)}]),angular.module("calaosApp").controller("LightRGBCtrl",["$scope","CalaosApp","ngDialog","$rootScope",function(e,t,o,n){var a=function(t){e.color="0"==t.state?"#000":t.state,console.log("updateState color: "+e.color),e.bool_status="0"!=t.state&&"#000000"!=t.state};e.colorPicker=function(){console.log("ColorPicker click"),o.open({template:"views/color-picker.html",controller:"ColorPickerCtrl",className:"ngdialog-theme-default",closeByDocument:!1,scope:e})},a(e.item),e.$watch("item",function(){a(e.item)},!0)}]),angular.module("calaosApp").controller("ColorPickerCtrl",["$scope","CalaosApp","ngDialog",function(e,t,o){console.log("currentColor: "+e.color),e.close=function(){o.close()},e.validColor=function(){console.log("Valid color clicked"),o.close(),t.setState(e.item,"set "+e.color)}}]),angular.module("calaosApp").controller("VarStringCtrl",["$scope","CalaosApp","ngDialog",function(e,t,o){var n=function(t){console.log(t),e.display_text=""==t.state?t.name:t.state,e.text=t.state};e.dialogText=function(){o.open({template:"views/dialog-text.html",controller:"StringDialogCtrl",className:"ngdialog-theme-default",closeByDocument:!1,scope:e})},n(e.item),e.$watch("item",function(){n(e.item)},!0)}]),angular.module("calaosApp").controller("StringDialogCtrl",["$scope","CalaosApp","ngDialog",function(e,t,o){e.close=function(){o.close()},e.validText=function(){o.close(),t.setState(e.item,e.text)}}]),angular.module("calaosApp").controller("ShutterCtrl",["$scope","CalaosApp","ngDialog",function(e,t,o){var n=function(t){if("shutter"==t.gui_type)e.shutter_state="true"==t.state;else if("shutter_smart"==t.gui_type){var o="0";t.state.startsWith("stop")?o=t.state.substring(5):t.state.startsWith("up")?o=t.state.substring(3):t.state.startsWith("down")&&(o=t.state.substring(5));parseInt(o);e.shutter_state=o<100}};n(e.item),e.$watch("item",function(){n(e.item)},!0)}]),angular.module("calaosApp").controller("AudioListCtrl",["$scope","$state","CalaosApp",function(e,t,o){e.audioRaw=o.getHomeData().audio}]),angular.module("calaosApp").controller("AudioPlayerCtrl",["$scope","$state","CalaosApp",function(e,t,o){}]),angular.module("calaosApp").controller("CameraListCtrl",["$scope","$state","CalaosApp",function(e,t,o){e.cameraSorted=o.getSortedCameraByRow(),e.cameras=o.getHomeData().cameras}]),angular.module("calaosApp").controller("CameraSingleCtrl",["$scope","$state","$stateParams","CalaosApp","$timeout",function(e,t,o,n,a){e.cameras=n.getHomeData().cameras,o.cameraId<0||o.cameraId>=e.cameras.length?(console.log("unkown camera "+o.cameraId),t.go("security.list")):e.camera=e.cameras[o.cameraId]}]);